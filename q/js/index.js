var physics_accuracy=3,mouse_influence=20,mouse_cut=5,gravity=1200,cloth_height=30,cloth_width=50,start_y=20,spacing=7,tear_distance=60;window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1000/60)};var canvas,ctx,cloth,boundsx,boundsy,mouse={down:false,button:1,x:0,y:0,px:0,py:0};var Point=function(a,b){this.x=a;this.y=b;this.px=a;this.py=b;this.vx=0;this.vy=0;this.pin_x=null;this.pin_y=null;this.constraints=[]};Point.prototype.update=function(a){if(mouse.down){var b=this.x-mouse.x,c=this.y-mouse.y,d=Math.sqrt(b*b+c*c);if(mouse.button==1){if(d<mouse_influence){this.px=this.x-(mouse.x-mouse.px)*1.8;this.py=this.y-(mouse.y-mouse.py)*1.8}}else{if(d<mouse_cut){this.constraints=[]}}}this.add_force(0,gravity);a*=a;nx=this.x+((this.x-this.px)*0.99)+((this.vx/2)*a);ny=this.y+((this.y-this.py)*0.99)+((this.vy/2)*a);this.px=this.x;this.py=this.y;this.x=nx;this.y=ny;this.vy=this.vx=0};Point.prototype.draw=function(){if(!this.constraints.length){return}var a=this.constraints.length;while(a--){this.constraints[a].draw()}};Point.prototype.resolve_constraints=function(){if(this.pin_x!=null&&this.pin_y!=null){this.x=this.pin_x;this.y=this.pin_y;return}var a=this.constraints.length;while(a--){this.constraints[a].resolve()}this.x>boundsx?this.x=2*boundsx-this.x:1>this.x&&(this.x=2-this.x);this.y<1?this.y=2-this.y:this.y>boundsy&&(this.y=2*boundsy-this.y)};Point.prototype.attach=function(a){this.constraints.push(new Constraint(this,a))};Point.prototype.remove_constraint=function(a){this.constraints.splice(this.constraints.indexOf(a),1)};Point.prototype.add_force=function(a,b){this.vx+=a;this.vy+=b};Point.prototype.pin=function(a,b){this.pin_x=a;this.pin_y=b};var Constraint=function(a,b){this.p1=a;this.p2=b;this.length=spacing};Constraint.prototype.resolve=function(){var b=this.p1.x-this.p2.x,c=this.p1.y-this.p2.y,d=Math.sqrt(b*b+c*c),a=(this.length-d)/d;if(d>tear_distance){this.p1.remove_constraint(this)}var e=b*a*0.5;var f=c*a*0.5;this.p1.x+=e;this.p1.y+=f;this.p2.x-=e;this.p2.y-=f};Constraint.prototype.draw=function(){ctx.moveTo(this.p1.x,this.p1.y);ctx.lineTo(this.p2.x,this.p2.y)};var Cloth=function(){this.points=[];var b=canvas.width/2-cloth_width*spacing/2;for(var d=0;d<=cloth_height;d++){for(var c=0;c<=cloth_width;c++){var a=new Point(b+c*spacing,start_y+d*spacing);c!=0&&a.attach(this.points[this.points.length-1]);d==0&&a.pin(a.x,a.y);d!=0&&a.attach(this.points[c+(d-1)*(cloth_width+1)]);this.points.push(a)}}};Cloth.prototype.update=function(){var a=physics_accuracy;while(a--){var b=this.points.length;while(b--){this.points[b].resolve_constraints()}}a=this.points.length;while(a--){this.points[a].update(0.016)}};Cloth.prototype.draw=function(){ctx.beginPath();var a=cloth.points.length;while(a--){cloth.points[a].draw()}ctx.stroke()};function update(){ctx.clearRect(0,0,canvas.width,canvas.height);cloth.update();cloth.draw();requestAnimFrame(update)}function start(){canvas.onmousedown=function(a){mouse.button=a.which;mouse.px=mouse.x;mouse.py=mouse.y;var b=canvas.getBoundingClientRect();mouse.x=a.clientX-b.left,mouse.y=a.clientY-b.top,mouse.down=true;a.preventDefault()};canvas.onmouseup=function(a){mouse.down=false;a.preventDefault()};canvas.onmousemove=function(a){mouse.px=mouse.x;mouse.py=mouse.y;var b=canvas.getBoundingClientRect();mouse.x=a.clientX-b.left,mouse.y=a.clientY-b.top,a.preventDefault()};canvas.oncontextmenu=function(a){a.preventDefault()};boundsx=canvas.width-1;boundsy=canvas.height-1;ctx.strokeStyle="#888";cloth=new Cloth();update()}window.onload=function(){canvas=document.getElementById("c");ctx=canvas.getContext("2d");canvas.width=560;canvas.height=350;start()};